name: Build & Attest Python Package

on:
  release:
    types: [published] # Roda quando você publica uma release nova na interface do GitHub

permissions:
  id-token: write      # OBRIGATÓRIO: Para gerar o token OIDC do Sigstore
  attestations: write  # OBRIGATÓRIO: Para gravar a atestação no GitHub
  contents: read       # Para ler o código

jobs:
  build-and-attest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install build tools
        run: pip install build

      - name: Build Artifacts (Wheel & Sdist)
        run: python -m build
        # Isso gera os arquivos na pasta dist/ (ex: seshat-0.1.0-py3-none-any.whl)

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'dist/*.whl' # Pega qualquer wheel gerado
          # Dica Pro: Se quiser assinar o .tar.gz também, use 'dist/*'

      # Opcional: Upload para a Release do GitHub
      - name: Upload Binaries to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*
          
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/juniormartinxo/seshat
      
      - name: Build and Push Docker Image
        id: push # Importante dar um ID para recuperar o digest depois
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Attest Docker Image
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ghcr.io/juniormartinxo/seshat
          subject-digest: ${{ steps.push.outputs.digest }} # Vincula ao hash exato da imagem gerada
          push-to-registry: true # Anexa a assinatura direto no registro